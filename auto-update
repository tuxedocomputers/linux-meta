#!/bin/bash

set -ex

UBUNTU_CODENAME=jammy
MAINLINE_KERNEL_VERSION=6.0
UBUNTU_KERNEL_META_BRANCH=oem-${MAINLINE_KERNEL_VERSION}

echo "===Starting auto-update.==="

SCRIPT=$(realpath "$0")
SCRIPTPATH=$(dirname "$SCRIPT")
cd "$SCRIPTPATH"

echo "===Fetching newest version from upstream.==="

if git remote | grep ubuntu-oem-${UBUNTU_CODENAME}; then
    git remote set-url ubuntu-oem-${UBUNTU_CODENAME} git://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-meta-oem/+git/${UBUNTU_CODENAME}
    git fetch ubuntu-oem-${UBUNTU_CODENAME} --prune
else
    git remote add -f --tags ubuntu-oem-${UBUNTU_CODENAME} git://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-meta-oem/+git/${UBUNTU_CODENAME}
fi

CURRENT_VERSION=$(grep -Pom1 '(?<=^linux-meta-tuxedo-22.04-edge \().*(?=\))' debian/changelog || true)
CURRENT_ABI=${CURRENT_VERSION%.*}
NEWEST_VERSION=$(git describe --tags ubuntu-oem-${UBUNTU_CODENAME}/${UBUNTU_KERNEL_META_BRANCH} --abbrev=0 | grep -Po "(?<=^Ubuntu-${UBUNTU_KERNEL_META_BRANCH}-).*(?=$)")
NEWEST_ABI=${NEWEST_VERSION%.*}

echo "Current Version Base: $CURRENT_ABI_BASE"
echo "Newest Version Base: $NEWEST_ABI"

if [ $CURRENT_ABI = $NEWEST_ABI ]; then
    echo "===Version already up to date. Exiting.==="
    exit
fi

echo "===Start metapackage update.==="

echo "===Checking out correct Ubuntu kernel.==="
if [ -z $LINUX_UBUNTU_OEM_REPO_URL ]; then
    LINUX_UBUNTU_OEM_REPO_URL="git://git.launchpad.net/~canonical-kernel/ubuntu/+source/linux-oem/+git/jammy"
fi
rm -rf ../linux-for-linux-meta
# Shallow cloning gives transport errors for some reason
#git clone --depth 1 --config advice.detachedHead=false $LINUX_REPO_URL ../linux-for-linux-meta
git clone --config advice.detachedHead=false $LINUX_UBUNTU_OEM_REPO_URL ../linux-for-linux-meta
git -C ../linux-for-linux-meta fetch --tags
git -C ../linux-for-linux-meta checkout $(git -C ../linux-for-linux-meta tag | grep Ubuntu-${UBUNTU_KERNEL_META_BRANCH}-${NEWEST_ABI%.*}-${NEWEST_ABI##*.})

echo "===Run update script.==="
./update-version ../linux-for-linux-meta auto-commit

echo "===Done.==="
